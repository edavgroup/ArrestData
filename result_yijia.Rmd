```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(dplyr)
library(tibble)
library(tidyr)
library(ggplot2)
library(forcats)
library(RSocrata)
library(UpSetR)
library(naniar)
library(rvest)
library(ggpubr)
library(ggalluvial)
library(choroplethr)
library(ggmap)
library(tmap)
library(scales)
library(lubridate)
```

```{r}
data =  read.socrata("https://data.cityofnewyork.us/Public-Safety/NYPD-Arrest-Data-Year-to-Date-/uip8-fykc")
data = data %>% select(-c(geocoded_column))
```


We want to investigate the number of arrest in NYC by NYPDs based on the borough of the arrest.

```{r}
crime_by_borough_plot = ggplot(data, aes(x = fct_infreq(arrest_boro))) +
  geom_bar(stat="count", color = "grey", fill = "lightBlue", 
                 binwidth = 5, center = 52.5) +
  labs(caption="Crime  by Borough", 
       x="borough", y="count")
crime_by_borough_plot
```

We want to explore if there is any monthly or seasonal pattern over time by plotting the number of arrest over time. If crime is tied to activities, the period at which activities end may impact.

```{r}
df_arrest_daily <- data %>%
  mutate(Date = as.Date(arrest_date, "%Y/%m/%d")) %>%
  group_by(Date) %>%
  summarize(count = n()) %>%
  arrange(Date)
fig_daily_arrest <- ggplot(df_arrest_daily, aes(x = Date, y = count)) +
  geom_line(color = "#F2CA27", size = 0.5) +
  geom_smooth(color = "#1A1A1A") +
  # fte_theme() +
  scale_x_date(breaks = date_breaks("1 month"), labels = date_format("%h")) +
  labs(x = "Date of Arrest", y = "# of Arrests", title = "Daily Arrests from 01/01/2022 to 9/30/2022")
fig_daily_arrest
```

This figure shows the number of daily arrests from January 1 2022, to September 30 2022. We can see there is no strong pattern over time. Nevertheless, there is a small increasing during the beginning of 2022 and a slight decreasing around July and August. Paying attention to January 1, 2022, which is the New Year, we can't conclude that the number of arrests happened on January 1 is higher. The graph shows that the number of crimes is not strongly related to the activities and time.

Then we will try to examine if the number of arrests has association with the day of week. We first need to derive the day of week based on the date. Also with subgroups, we can verify if there is a latent factor.

```{r}
data$dayofweek <- wday(data$arrest_date, label=TRUE, abbr=FALSE)
df_weekday <- data %>%
  mutate(dayofweek=dayofweek, month=months(as.Date(data$arrest_date))) %>%
  group_by(dayofweek, month) %>%
  summarize(count = n()) %>%
  arrange(dayofweek)
df_weekday$month <- factor(df_weekday$month, levels = c('January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September'))
```


```{r}
plot <- ggplot(df_weekday, aes(x = month, y = dayofweek, fill = count)) +
  geom_tile() +
  scale_x_discrete(name = "Month" )+
  # fte_theme() +
  theme(legend.title = element_blank(), legend.position="top", legend.direction="horizontal", legend.key.width=unit(2, "cm"), legend.key.height=unit(0.25, "cm"), legend.margin=unit(-0.5,"cm"), panel.margin=element_blank()) +
  labs(x = "Month", y = "Day of Week of Arrest", title = "Number of Arrests in NYC in 2022, by Day of Week of Arrest") +
  scale_fill_gradient(low = "white", high = "#27AE60", labels = comma)
plot
```

By plotting the heatmap of the number of arrests in NYC over time categorized by the day of week, we can notice a pattern that there are more arrests during the weekday than during weekends, specifically on Tuesday, Wednesday and Thursday. Moreover, from the graph, we can see that in January and February, overall there are fewer arrests in NYC compared to other months.

We also want to examine if certain types of crime may be more time dependent. For example, more traffic violations when people leave work.


```{r}
data = data %>%
  mutate(month=months(as.Date(data$arrest_date)))
```

```{r}
df_top_crimes <- data %>%
  group_by(ofns_desc) %>% 
  summarize(count = n()) %>%
  arrange(desc(count))

df_crime <- data %>%
  filter(ofns_desc %in% df_top_crimes$ofns_desc[1:24]) %>%
  group_by(ofns_desc, dayofweek, month) %>% 
  summarize(count = n())

df_crime$month <- factor(df_crime$month, levels = c('January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September'))
```

```{r, fig.width = 10}
plot <- ggplot(df_crime , aes(x = month, y = dayofweek, fill = count)) +
  geom_tile() +
  scale_x_discrete(name = "Month" )+
  # fte_theme() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.6, size = 4))+
  labs(x = "Month", y = "Day of Week of Arrest", title = "Number of Arrests in NYC in 2022 by Category and Time of Arrest") +
  scale_fill_gradient(low = "white", high = "#2980B9") +
  facet_wrap(~ ofns_desc, nrow = 4)
plot
```

We can see there is no strong relation among the day of week and the type of crimes, which is consistent with the general pattern. That is there are more arrests during the weekdays in general. For the crime type with the highest frequency, assault and related offenses are not time dependent and there is no certain pattern.

这个可能要算到type of crime里和borough
We also want to consider the factor by borough. 

