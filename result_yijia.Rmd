```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(dplyr)
library(tibble)
library(tidyr)
library(ggplot2)
library(forcats)
library(RSocrata)
library(UpSetR)
library(naniar)
library(rvest)
library(ggpubr)
library(ggalluvial)
library(choroplethr)
library(ggmap)
library(tmap)
library(scales)
library(lubridate)
```

```{r}
data =  read.socrata("https://data.cityofnewyork.us/Public-Safety/NYPD-Arrest-Data-Year-to-Date-/uip8-fykc")
data = data %>% select(-c(geocoded_column))
```

```{r}
data <- data %>%
  drop_na(pd_desc, ky_cd, pd_cd)
#这里可能要修改一下，因为我也不知道咋处理的missing data
```

We want to investigate the number of arrest in NYC by NYPDs based on the borough of the arrest.

```{r}
crime_by_borough_plot = ggplot(data, aes(x = fct_infreq(arrest_boro))) +
  geom_bar(stat="count", color = "grey", fill = "lightBlue", 
                 binwidth = 5, center = 52.5) +
  labs(caption="Crime  by Borough", 
       x="borough", y="count")
crime_by_borough_plot
```

We want to explore if there is any monthly or seasonal pattern over time by plotting the number of arrest over time.

```{r}
df_arrest_daily <- data %>%
  mutate(Date = as.Date(arrest_date, "%Y/%m/%d")) %>%
  group_by(Date) %>%
  summarize(count = n()) %>%
  arrange(Date)
fig_daily_arrest <- ggplot(df_arrest_daily, aes(x = Date, y = count)) +
  geom_line(color = "#F2CA27", size = 0.5) +
  geom_smooth(color = "#1A1A1A") +
  # fte_theme() +
  scale_x_date(breaks = date_breaks("1 month"), labels = date_format("%h")) +
  labs(x = "Date of Arrest", y = "# of Arrests", title = "Daily Arrests from 01/01/2022 to 9/30/2022")
fig_daily_arrest
```

This figure shows the number of daily arrests from January 1 2022, to September 30 2022. We can see there is no strong pattern over time. Nevertheless, there is a small increasing during the beginning of 2022 and a slight decreasing around July and August. Then we will try to examine if the number of arrests has association with the day of week. We first need to derive the day of week based on the date. Also with subgroups, we can verify if there is a latent factor.

```{r}
data$dayofweek <- wday(data$arrest_date, label=TRUE, abbr=FALSE)
df_weekday <- data %>%
  mutate(dayofweek=dayofweek, month=months(as.Date(data$arrest_date))) %>%
  group_by(dayofweek, month) %>%
  summarize(count = n()) %>%
  arrange(dayofweek)
df_weekday$month <- factor(df_weekday$month, levels = c('January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September'))
```


```{r}
plot <- ggplot(df_weekday, aes(x = month, y = dayofweek, fill = count)) +
  geom_tile() +
  scale_x_discrete(name = "Month" )+
  # fte_theme() +
  theme(legend.title = element_blank(), legend.position="top", legend.direction="horizontal", legend.key.width=unit(2, "cm"), legend.key.height=unit(0.25, "cm"), legend.margin=unit(-0.5,"cm"), panel.margin=element_blank()) +
  labs(x = "Month", y = "Day of Week of Arrest", title = "Number of Arrests in NYC in 2022, by Day of Week of Arrest") +
  scale_fill_gradient(low = "white", high = "#27AE60", labels = comma)
plot
```

By plotting the heatmap of the number of arrests in NYC over time categorized by the day of week, we can notice a pattern that there are more arrests during the weekday than during weekends, specifically on Tuesday, Wednesday and Thursday. Moreover, from the graph, we can see that in January and February, overall there are fewer arrests in NYC compared to other months.

We also want to examine if certain types of crime may be more time dependent. For example, more traffic violations when people leave work.



